#!/bin/bash
set -euo pipefail  # Exit on error, undefined vars, pipe failures

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKUP_DIR="$HOME/.dotfiles_backup_$(date +%Y%m%d_%H%M%S)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

link_file() {
    local src="$1"
    local dst="$2"
    
    # Check if source exists
    if [[ ! -e "$src" ]]; then
        log_error "Source does not exist: $src"
        return 1
    fi
    
    # Backup existing file/link if it exists and isn't already our symlink
    if [[ -e "$dst" || -L "$dst" ]]; then
        if [[ -L "$dst" ]] && [[ "$(readlink "$dst")" == "$src" ]]; then
            log_info "Already linked: $dst"
            return 0
        fi
        
        mkdir -p "$BACKUP_DIR"
        mv "$dst" "$BACKUP_DIR/"
        log_warn "Backed up existing: $dst -> $BACKUP_DIR/"
    fi
    
    # Create parent directory if needed
    mkdir -p "$(dirname "$dst")"
    
    # Create symlink
    if ln -sf "$src" "$dst"; then
        log_info "Linked: $dst -> $src"
        return 0
    else
        log_error "Failed to link: $dst"
        return 1
    fi
}

main() {
    log_info "Starting dotfiles setup from: $DOTFILES_DIR"
    
    # Home directory dotfiles
    local home_dotfiles=("bashrc" "vimrc")
    for file in "${home_dotfiles[@]}"; do
        link_file "$DOTFILES_DIR/$file" "$HOME/.$file"
    done
    
    # Config directory files
    link_file "$DOTFILES_DIR/starship.toml" "$HOME/.config/starship.toml"
    
    # Bin directory
    link_file "$DOTFILES_DIR/bin" "$HOME/.local/bin"
    
    log_info "Dotfiles setup complete!"
    [[ -d "$BACKUP_DIR" ]] && log_warn "Backups saved to: $BACKUP_DIR"
}

main "$@"
